<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<title>CAR GAME</title>
	<style type="text/css">
	 @font-face
    {
     font-family: 'MatrixCode';
     src: url("./fonts/MatrixCode.otf") format("opentype");
    }
	#sence{border:1px solid #ccc;position:relative;}
	.mainbox{
		width:100%;
		margin:0 auto;
		height: 100%;
	}
	#block{width:50px;height:50px;background:#f00;position:fixed;left:0;top:0;}

	@-webkit-keyframes reverseRotataZ{
    0%{-webkit-transform: rotateZ(0deg);}
    100%{-webkit-transform: rotateZ(-360deg);}
    }
    @-webkit-keyframes rotataZ{
    0%{-webkit-transform: rotateZ(0deg);}
    100%{-webkit-transform: rotateZ(360deg);}
    }
    #musicControl { position:fixed;right:450px;top:40px;margin-top:0;display:inline-block;z-index:99999999}
    #musicControl a { display:inline-block;width: 25px; height: 25px;overflow:hidden;background:url('./images/mcbg.png') no-repeat;background-size:100%;}
    #musicControl a audio{width:100%;height:56px;}
    #musicControl a.stop { background-position:left bottom;}
    #musicControl a.on { background-position:0px 1px;-webkit-animation: reverseRotataZ 1.2s linear infinite;}
	</style>
	<style media="screen">
	.mask {
z-index: 9998;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:#000;
opacity:0.4;
filter:alpha(opacity=40);
display:none
}
.onmask {
z-index:9999;
position: fixed;
margin: 0 auto;
/*position:fixed;*/
top:30%;
left:10%;
width:200px;
height:120px;
margin:0 auto;
border-radius:5px;
border:solid 2px #666;
/*background-color:blue;*/
color: white;
text-align: center;
display:none;
box-shadow: 0 0 10px #666;
}
	</style>
	<style type="text/css">
	/*Stylesheet*/
BODY, HTML
{
		-webkit-tap-highlight-color: rgba(0,0,0,0);
		-webkit-touch-callout: none;
		-webkit-text-size-adjust: none;
		-webkit-user-select: none;
	margin: 			0;
	padding: 			0;
	font-family: 		Arial, Verdana, sans-serif;
	font-size: 			12px;
	font-weight:		normal;
	color: 				#ccc;
	background-color:	white;
	overflow-x:hidden;
  overflow-y:hidden;
}

#sence {
	width: 100%;
	height: 100%;
	/*position: absolute;*/
	text-align:center;
	margin: 0 auto;
		display: block !important;
}
	</style>
</head>

<body>
	<div class="mask" id="mask">

	</div>
	<div class="onmask" id="safe">
		<h1>开车时一定要系安全带</h1>
	</div>
	<div class="onmask" id="phone">
		<div class="" style="float:left;width:20%">
			<img src="images/phone.png" width="50%" alt="" />
		</div>
		<div class="">
			<h1>老板来电话了！</h1>
			<h2><a id="jie">接</a><a id="bujie" style="margin-left:100px">不接</a></h2>
			<h2><a id="text"></a></h2>
		</div>

	</div>
<div class="mainbox" id="main">

	<canvas id="sence" width="400" height="400"></canvas>
</div>
<span id="musicControl" style="display:none">
    <a id="mc_play" class="stop on" onclick="play_music();">
        <audio id="bgmusic" loop="loop" autoplay="autoplay">
            <source src="http://resources-user-audio.vxue360.com/778f8723e176c828c280f7c9b7eb6e00.mp3" type="audio/mpeg">
        </audio>
    </a>
    <a id="coin_play" style="display:none">
        <audio id="coinmusic" loop="loop">
            <source src="http://resources-user-audio.vxue360.com/778f8723e176c828c280f7c9b7eb6e00.mp3" type="audio/mpeg">
        </audio>
    </a>
</span>
<script src="lib/jquery.js"></script>
<script src="lib/util.js"></script>
<script src="lib/entities.js"></script>
<script src="user-entities.js"></script>
<script src="lib/patch-enhancement.js"></script>
<script src="lib/main_app.js"></script>

<script type="text/javascript">
var gnfx=document.documentElement.clientWidth;
var gnfy=document.documentElement.clientHeight;
var runWithOther=true;
var screenObjects = [];
var startTime = null;
var welcome;
var resources = [
	{'name': 'car1', src: 'images/car1.png', type: 'images'},
	{'name': 'car2', src: 'images/car2.png', type: 'images'},
	{'name': 'car3', src: 'images/car3.png', type: 'images'},
	{'name': 'car4', src: 'images/car4.png', type: 'images'},
	{'name': 'car5', src: 'images/car5.png', type: 'images'},
	{'name': 'car_p', src: 'images/car_p.png', type: 'images'},
	{'name': 'saint', src: 'images/saint.png', type: 'images'},
	{'name': 'soldier', src: 'images/soldier.png', type: 'images'},
	{'name': 'tree', src: 'images/tree.png', type: 'images'},
	{'name': 'road', src: 'images/road.png', type: 'images'},
	{'name': 'bike', src: 'images/bike.png', type: 'images'},
	{'name': 'ask' , src: 'images/ask.jpeg', type: 'images'},
	{'name': 'road1',src: 'images/road1.png',type: 'images'},
	{'name': 'back' ,src: 'images/back.jpg' ,type: 'images'},
	{'name': 'schoolBus', src: 'images/2.png', type: 'images'},
	{'name': 'roadD', src: 'images/5.png', type: 'images'},
	{'name': 'roadG1', src: 'images/9.png', type: 'images'},
	{'name': 'roadG', src: 'images/11.png', type: 'images'},
	{'name': 'pai', src: 'images/7.png', type: 'images'},
	{'name':'yes',src:'images/yes.png',type:'images'},
	{'name':'no',src:'images/no.png',type:'images'}
];
resourceLoader.onProgress = function(e){
	loadScreen.setProgress(e.loadedCount / e.totalCount);
};

resourceLoader.onComplete = function(){
	ScreenObjPool.remove(loadScreen);
	//showWelcome();
	//gameJieshao();
	//lineGame();
	//avoidGame();
	background();
	//gameSafe();
	//runWithOther();
	//startGame();
};
var loadScreen = new LoadScreen();

MainApp.init();

MainApp.startRun();

ScreenObjPool.add(loadScreen);

resourceLoader.load(resources);

document.getElementById("sence").width=gnfx;
document.getElementById("sence").height=gnfy;
console.log(gnfx,gnfy);
function showWelcome(){
	var logo = new TextEntityObject('CAR RACE', new Vector(100*gnfx/400, 150*gnfy/710), {fillStyle: '#900', font: 'bold '+100*gnfx/400+'px 微软雅黑', 'textBaseline': 'top'}, 200*gnfx/400, 35*gnfy/710);

	welcome = new TextEntityObject('点击开始', new Vector(140*gnfx/400, 350*gnfy/710), {fillStyle: '#333', font: 'bold '+24*gnfx/400+'px 微软雅黑', 'textBaseline': 'top'}, 100*gnfx/400, 35*gnfy/710);
	MainApp.addEventListener(welcome, 'mouseover', function(e){
		welcome.setStyle({fillStyle: '#999'});
	});

	MainApp.addEventListener(welcome, 'mouseout', function(e){
		welcome.setStyle({fillStyle: '#333'});
	});

	MainApp.addEventListener(welcome, 'click', function(e){
		ScreenObjPool.remove(logo);
		ScreenObjPool.remove(welcome);
		gameJieshao();
	});
	ScreenObjPool.add(logo);
	ScreenObjPool.add(welcome);

}
var SCORE = 0;
function startGame(){
    var road = new ImageEntityObject(resourceLoader.get('roadG1'), new Vector(0, -710*gnfy/710), 400*gnfx/400, 1420*gnfy/710, new Vector(0,100));
	ScreenObjPool.add(road);

	var images = [];
	images.push(resourceLoader.resources.car1);
	images.push(resourceLoader.resources.car2);
	images.push(resourceLoader.resources.car3);
	images.push(resourceLoader.resources.car4);
	images.push(resourceLoader.resources.car5);
	for(var i = 0; i < 3; i++){
		var img =  images[util.random(0, images.length - 1)];
		var temp=util.random(0,3);
		var newCar = new Car(new Vector((temp * 74 + 55)*gnfx/400, window.util.random(-480, -80)*gnfy/710), window.util.randomColor(), img);
		newCar.hitable = true;
		ScreenObjPool.add(newCar);
	}
	var scorePre = new TextEntityObject('Score: ', new Vector(50, 5), {fillStyle: '#fff', font: 'bold 32px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	ScreenObjPool.add(scorePre);
	//var score = new TextEntityObject('0', new Vector(160, 5), {fillStyle: '#fff', font: 'bold 32px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	var score = new GameScore(0, new Vector(160, 5));
	ScreenObjPool.add(score);

	var leftC = new CollisionEntityObject(new Vector(0, 0), 40*gnfx/400, 710*gnfy/710);
	var rightC = new CollisionEntityObject(new Vector(325*gnfx/400, 0), 75*gnfx/400, 710*gnfy/710);
	var topC = new CollisionEntityObject(new Vector(0, 0), 400*gnfx/400, 20*gnfy/710);
	var bottomC = new CollisionEntityObject(new Vector(0, 710*gnfy/710), 400*gnfx/400, 10);
	var cMap = new CollistionMap();
	cMap.add(leftC);
	cMap.add(rightC);
	cMap.add(topC);
	cMap.add(bottomC);

	var myCar = new Car(new Vector(200*gnfx/400, 600*gnfy/710), window.util.randomColor(), resourceLoader.resources.car_p, new Vector(0, 0));
	myCar.setCollisionMap(cMap);
	MainApp.addEventListener(myCar, 'keyup', function(e){
		var KEY = MainApp.INPUT.KEY;
		switch(e.which){
			case KEY.UP:
				if(KEY_LOCK.UP){
					this.speed.remove(new Vector(0, -20));
					KEY_LOCK.UP = false;
				}
				break;
			case KEY.DOWN:
				if(KEY_LOCK.DOWN){
					this.speed.remove(new Vector(0, 20));
					KEY_LOCK.DOWN = false;
				}
				break;
			case KEY.LEFT:
				if(KEY_LOCK.LEFT){
					this.speed.remove(new Vector(-20, 0));
					KEY_LOCK.LEFT = false;
				}
				break;
			case KEY.RIGHT:
				if(KEY_LOCK.RIGHT){
					this.speed.remove(new Vector(20, 0));
					KEY_LOCK.RIGHT = false;
				}
				break;
		}
	});

	MainApp.addEventListener(myCar, 'keydown', function(e){
		var KEY = MainApp.INPUT.KEY;
		switch(e.which){
			case KEY.UP:
				if(!KEY_LOCK.UP){
					myCar.speed.add(new Vector(0, -20));
					console.log(myCar.speed);
					KEY_LOCK.UP = true;
				}
				break;
			case KEY.DOWN:
				if(!KEY_LOCK.DOWN){
					myCar.speed.add(new Vector(0, 20));
					KEY_LOCK.DOWN = true;
				}
				break;
			case KEY.LEFT:
				if(!KEY_LOCK.LEFT){
					myCar.speed.add(new Vector(-20, 0));
					KEY_LOCK.LEFT = true;
				}
				break;
			case KEY.RIGHT:
				if(!KEY_LOCK.RIGHT){
					myCar.speed.add(new Vector(20, 0));
					KEY_LOCK.RIGHT = true;
				}
				break;
		}

	});

	MainApp.addEventListener(myCar, 'hit', function(e){//弹框  不能撞击其他车辆
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		endGame(score.score);
	});




	// if (runWithOther) {
	// 	runWithOther();
	// }
}
//最后一个的逻辑，小车排队不能变道
function lineGame(){
	var road = new ImageEntityObject(resourceLoader.get('roadD'), new Vector(0, -710*gnfy/710), 400*gnfx/400, 1420*gnfy/710, new Vector(0,100));
    ScreenObjPool.add(road);
	var img =  resourceLoader.resources.car5;
	var newCar = new Car(new Vector(200*gnfx/400, 0*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car1;
	var newCar = new Car(new Vector(200*gnfx/400, 100*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car2;
	var newCar = new Car(new Vector(200*gnfx/400, 200*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car3;
	var newCar = new Car(new Vector(200*gnfx/400, 300*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car2;
	var newCar = new Car(new Vector(200*gnfx/400, 620*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);

	var img =  resourceLoader.resources.car4;
	var newCar = new ConverseCar(new Vector(125*gnfx/400, 20*gnfy/710), window.util.randomColor(), img, new Vector(0, 200*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);

	var leftC = new CollisionEntityObject(new Vector(0, 0), 40*gnfx/400, 710*gnfy/710);
	var rightC = new CollisionEntityObject(new Vector(325*gnfx/400, 0), 75*gnfx/400, 710*gnfy/710);
	var topC = new CollisionEntityObject(new Vector(0, 0), 400*gnfx/400, 20*gnfy/710);
	var bottomC = new CollisionEntityObject(new Vector(0, 710*gnfy/710), 400*gnfx/400, 10);
	var cMap = new CollistionMap();
	cMap.add(leftC);
	cMap.add(rightC);
	cMap.add(topC);
	cMap.add(bottomC);

	var myCar = new Car(new Vector(200*gnfx/400, 500*gnfy/710), window.util.randomColor(), resourceLoader.resources.car_p, new Vector(0, 0));
	myCar.setCollisionMap(cMap);
	MainApp.addEventListener(myCar, 'keyup', function(e){
		var KEY = MainApp.INPUT.KEY;
		switch(e.which){
			case KEY.UP:
				if(KEY_LOCK.UP){
					this.speed.remove(new Vector(0, -40));
					KEY_LOCK.UP = false;
				}
				break;
			case KEY.DOWN:
				if(KEY_LOCK.DOWN){
					this.speed.remove(new Vector(0, 40));
					KEY_LOCK.DOWN = false;
				}
				break;
			case KEY.LEFT:
				if(KEY_LOCK.LEFT){
					this.speed.remove(new Vector(-40, 0));
					KEY_LOCK.LEFT = false;
				}
				break;
			case KEY.RIGHT:
				if(KEY_LOCK.RIGHT){
					this.speed.remove(new Vector(40, 0));
					KEY_LOCK.RIGHT = false;
				}
				break;
		}
	});

	MainApp.addEventListener(myCar, 'keydown', function(e){
		var KEY = MainApp.INPUT.KEY;
		switch(e.which){
			case KEY.UP:
				if(!KEY_LOCK.UP){
					myCar.speed.add(new Vector(0, -40));
					KEY_LOCK.UP = true;
				}
				break;
			case KEY.DOWN:
				if(!KEY_LOCK.DOWN){
					myCar.speed.add(new Vector(0, 40));
					KEY_LOCK.DOWN = true;
				}
				break;
			case KEY.LEFT:
				if(!KEY_LOCK.LEFT){
					myCar.speed.add(new Vector(-40, 0));
					KEY_LOCK.LEFT = true;
				}
				break;
			case KEY.RIGHT:
				if(!KEY_LOCK.RIGHT){
					myCar.speed.add(new Vector(40, 0));
					KEY_LOCK.RIGHT = true;
				}
				break;
		}
	});
	MainApp.addEventListener(myCar, 'hit', function(e){//弹框不能撞击其他车辆
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		//endGame(score.score);
	});
	myCar.lineable=true;
	MainApp.addEventListener(myCar, 'line', function(e){//不能向公交车专用道或者对向车道变道
		alert("line");
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
	});
	myCar.end=true;
	MainApp.addEventListener(myCar, 'end', function(e){//全屏幕，游戏结束（最后做）
		alert("end");
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
	});
	myCar.addcar=true;
	MainApp.addEventListener(myCar, 'addcar', function(e){
    myCar.addcar=false;
		var img =  resourceLoader.resources.car5;
		var newCar = new Car(new Vector(200*gnfx/400, 700*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
		newCar.hitable = true;
		ScreenObjPool.add(newCar);
		// var img =  resourceLoader.resources.car5;
		// var newCar = new Car(new Vector(200*gnfx/400, 700*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
		// newCar.hitable = true;
		// ScreenObjPool.add(newCar);
	});
	ScreenObjPool.add(myCar);
}
//倒数第二个逻辑，避让行人
function avoidGame(){
	var road = new ImageEntityObject(resourceLoader.get('road'), new Vector(0, 0), 640, 480);
	ScreenObjPool.add(road);
	var img =  resourceLoader.resources.car1;
	var newCar = new Car(new Vector(320, 100), window.util.randomColor(), img, new Vector(-10,20));
	newCar.hitable = true;
	newCar.avoid=true;
	ScreenObjPool.add(newCar);
	var tree = new Magic(new Vector(370, 0), resourceLoader.get('car1'), Magic.ANIM_TYPE.HORIZONTAL, 50);
	ScreenObjPool.add(tree);

	var bike = new Magic(new Vector(500, 0), resourceLoader.get('bike'), Magic.ANIM_TYPE.HORIZONTAL, 73);
	ScreenObjPool.add(bike);

	var leftC = new CollisionEntityObject(new Vector(0, 0), 30, 480);
	var rightC = new CollisionEntityObject(new Vector(350, 0), 20, 480);
	var topC = new CollisionEntityObject(new Vector(0, 0), 640, 0);
	var bottomC = new CollisionEntityObject(new Vector(0, 480), 640, 10);
	var cMap = new CollistionMap();
	cMap.add(leftC);
	cMap.add(rightC);
	cMap.add(topC);
	cMap.add(bottomC);

	var myCar = new Car(new Vector(240, 390), window.util.randomColor(), resourceLoader.resources.car_p, new Vector(0, 0));
	myCar.setCollisionMap(cMap);
	MainApp.addEventListener(myCar, 'keyup', function(e){
		var KEY = MainApp.INPUT.KEY;
		switch(e.which){
			case KEY.UP:
				if(KEY_LOCK.UP){
					this.speed.remove(new Vector(0, -200));
					KEY_LOCK.UP = false;
				}
				break;
			case KEY.DOWN:
				if(KEY_LOCK.DOWN){
					this.speed.remove(new Vector(0, 200));
					KEY_LOCK.DOWN = false;
				}
				break;
			case KEY.LEFT:
				if(KEY_LOCK.LEFT){
					this.speed.remove(new Vector(-200, 0));
					KEY_LOCK.LEFT = false;
				}
				break;
			case KEY.RIGHT:
				if(KEY_LOCK.RIGHT){
					this.speed.remove(new Vector(200, 0));
					KEY_LOCK.RIGHT = false;
				}
				break;
		}
	});

	MainApp.addEventListener(myCar, 'keydown', function(e){
		var KEY = MainApp.INPUT.KEY;
		switch(e.which){
			case KEY.UP:
				if(!KEY_LOCK.UP){
					myCar.speed.add(new Vector(0, -200));
					KEY_LOCK.UP = true;
				}
				break;
			case KEY.DOWN:
				if(!KEY_LOCK.DOWN){
					myCar.speed.add(new Vector(0, 200));
					KEY_LOCK.DOWN = true;
				}
				break;
			case KEY.LEFT:
				if(!KEY_LOCK.LEFT){
					myCar.speed.add(new Vector(-200, 0));
					KEY_LOCK.LEFT = true;
				}
				break;
			case KEY.RIGHT:
				if(!KEY_LOCK.RIGHT){
					myCar.speed.add(new Vector(200, 0));
					KEY_LOCK.RIGHT = true;
				}
				break;
		}
	});
	MainApp.addEventListener(myCar, 'hit', function(e){//弹框，不能撞击行人
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		//endGame(score.score);
	});
	MainApp.addEventListener(myCar, 'avoid', function(e){//全屏幕，成功避让行人，下一关
		alert("avoid");
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		//endGame(score.score);
	});
	ScreenObjPool.add(myCar);
}
//在高架上时的背景车道，只是要变道逻辑时
function background(){
	var road = new ImageEntityObject(resourceLoader.get('roadG'), new Vector(0, -2840*gnfy/710), 400*gnfx/400, 3550*gnfy/710, new Vector(0,100));
	road.miss=true;
	road.change=true;
	road.cline=true;
	ScreenObjPool.add(road);
	var images = [];
	images.push(resourceLoader.resources.car1);
	images.push(resourceLoader.resources.car2);
	images.push(resourceLoader.resources.car3);
	images.push(resourceLoader.resources.car4);
	images.push(resourceLoader.resources.car5);
	for(var i = 0; i < 3; i++){
		var img =  images[util.random(0, images.length - 1)];
		var temp=util.random(0,2);
		var newCar = new Car(new Vector((temp * 74 + 55)*gnfx/400, window.util.random(-480, -80)*gnfy/710), window.util.randomColor(), img,new Vector(0, 130),2);
		newCar.hitable = true;
		ScreenObjPool.add(newCar);
	}
	var scorePre = new TextEntityObject('Score: ', new Vector(50, 5), {fillStyle: '#fff', font: 'bold 32px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	ScreenObjPool.add(scorePre);
	//var score = new TextEntityObject('0', new Vector(160, 5), {fillStyle: '#fff', font: 'bold 32px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	var score = new GameScore(0, new Vector(160, 5));
	ScreenObjPool.add(score);

	var leftC = new CollisionEntityObject(new Vector(0, 0), 40*gnfx/400, 710*gnfy/710);
	var rightC = new CollisionEntityObject(new Vector(325*gnfx/400, 0), 75*gnfx/400, 710*gnfy/710);
	var topC = new CollisionEntityObject(new Vector(0, 0), 400*gnfx/400, 20*gnfy/710);
	var bottomC = new CollisionEntityObject(new Vector(0, 710*gnfy/710), 400*gnfx/400, 10);
	var cMap = new CollistionMap();
	cMap.add(leftC);
	cMap.add(rightC);
	cMap.add(topC);
	cMap.add(bottomC);

	var myCar = new Car(new Vector(200*gnfx/400, 600*gnfy/710), window.util.randomColor(), resourceLoader.resources.car_p, new Vector(0, 0));
	myCar.setCollisionMap(cMap);
	MainApp.addEventListener(myCar, 'keyup', function(e){
		var KEY = MainApp.INPUT.KEY;
		switch(e.which){
			case KEY.UP:
				if(KEY_LOCK.UP){
					this.speed.remove(new Vector(0, -40));
					KEY_LOCK.UP = false;
				}
				break;
			case KEY.DOWN:
				if(KEY_LOCK.DOWN){
					this.speed.remove(new Vector(0, 40));
					KEY_LOCK.DOWN = false;
				}
				break;
			case KEY.LEFT:
				if(KEY_LOCK.LEFT){
					this.speed.remove(new Vector(-40, 0));
					KEY_LOCK.LEFT = false;
				}
				break;
			case KEY.RIGHT:
				if(KEY_LOCK.RIGHT){
					this.speed.remove(new Vector(40, 0));
					KEY_LOCK.RIGHT = false;
				}
				break;
		}
	});

	MainApp.addEventListener(myCar, 'keydown', function(e){
		var KEY = MainApp.INPUT.KEY;
		switch(e.which){
			case KEY.UP:
				if(!KEY_LOCK.UP){
					myCar.speed.add(new Vector(0, -40));
					console.log(myCar.speed);
					KEY_LOCK.UP = true;
				}
				break;
			case KEY.DOWN:
				if(!KEY_LOCK.DOWN){
					myCar.speed.add(new Vector(0, 40));
					KEY_LOCK.DOWN = true;
				}
				break;
			case KEY.LEFT:
				if(!KEY_LOCK.LEFT){
					myCar.speed.add(new Vector(-40, 0));
					KEY_LOCK.LEFT = true;
				}
				break;
			case KEY.RIGHT:
				if(!KEY_LOCK.RIGHT){
					myCar.speed.add(new Vector(40, 0));
					KEY_LOCK.RIGHT = true;
				}
				break;
		}

	});

	MainApp.addEventListener(myCar, 'hit', function(e){
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		endGame(score.score);
	});
	MainApp.addEventListener(myCar, 'cline', function(e){//弹框实现不能变道
		alert("cline");
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		endGame(score.score);
	});
	MainApp.addEventListener(myCar, 'miss', function(e){//弹框，错过了下高架
		alert("miss");
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		//endGame(score.score);
	});
	MainApp.addEventListener(myCar, 'change', function(e){//全屏幕，正确下高架，经行下一关
		alert("change");
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		//endGame(score.score);
	});
	ScreenObjPool.add(myCar);
}

function stop_coin_music(){
	$('#coin_play audio').get(0).pause();
}

function play_coin_music(){
	$('#coin_play audio').get(0).load();
	$('#coin_play audio').get(0).play();
	var t=setTimeout("stop_coin_music()",5000);
}

function stopGame() {
	//var stop=new ;
	MainApp.stopRun();
}
function endGame(score){

	var end = new TextEntityObject('GAME OVER', new Vector(120, 150), {fillStyle: '#900', font: 'bold 64px 微软雅黑', 'textBaseline': 'top'}, 100, 35);

	ScreenObjPool.add(end);

	var score = new TextEntityObject('Score: ' + ~~score, new Vector(240,240), {fillStyle: '#000', font: 'bold 32px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	ScreenObjPool.add(score);

	var restart = new TextEntityObject('重新开始', new Vector(267, 310), {fillStyle: '#333', font: 'bold 24px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	MainApp.addEventListener(restart, 'mouseover', function(e){
		restart.setStyle({fillStyle: '#999'});
	});


	MainApp.addEventListener(restart, 'mouseout', function(e){
		restart.setStyle({fillStyle: '#333'});
	});

	ScreenObjPool.add(restart);

	MainApp.addEventListener(restart, 'click', function(e){
		ScreenObjPool.remove(end);
		ScreenObjPool.remove(restart);

		startGame();
	});

}


var KEY_LOCK = {
	LEFT: false,
	RIGHT: false,
	UP: false,
	DOWN: false
}

</script>
<script type="text/javascript">
function play_music(){
    if ($('#mc_play').hasClass('on')){
        $('#mc_play audio').get(0).pause();
        $('#mc_play').attr('class','stop');
    }else{
        $('#mc_play audio').get(0).play();
        $('#mc_play').attr('class','on');
    }
    event.stopPropagation(); //阻止冒泡
}
function just_play(id){
    $('#mc_play audio').get(0).play();
    $('#mc_play').attr('class','on');
    event.stopPropagation(); //阻止冒泡
}
    function is_weixn(){
        return false;
        var ua = navigator.userAgent.toLowerCase();
        if(ua.match(/MicroMessenger/i)=="micromessenger") {
            return true;
        } else {
            return false;
        }
    }
    window.onload=function(){
        if (!is_weixn()){
            just_play();
        }
    }
</script>
<script src="gameCtrl.js"></script>
<script src="webview.js" charset="utf-8"></script>

</body>
</html>
