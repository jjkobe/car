<!DOCTYPE html>
<html>
<head>
	<!-- <meta http-equiv="content-type" content="text/html; charset=UTF-8" /> -->
	<meta name="viewport" content="width=device-width, initial-scale=1" charset='UTF-8' />
	<title>CAR GAME</title>
	<style type="text/css">
	 @font-face
    {
     font-family: 'MatrixCode';
     src: url("./fonts/MatrixCode.otf") format("opentype");
    }
	#sence{border:1px solid #ccc;position:relative;}
	.mainbox{
		width:100%;
		margin:0 auto;
		height: 100%;
	}
	#block{width:50px;height:50px;background:#f00;position:fixed;left:0;top:0;}

	@-webkit-keyframes reverseRotataZ{
    0%{-webkit-transform: rotateZ(0deg);}
    100%{-webkit-transform: rotateZ(-360deg);}
    }
    @-webkit-keyframes rotataZ{
    0%{-webkit-transform: rotateZ(0deg);}
    100%{-webkit-transform: rotateZ(360deg);}
    }
    #musicControl { position:fixed;right:450px;top:40px;margin-top:0;display:inline-block;z-index:99999999}
    #musicControl a { display:inline-block;width: 25px; height: 25px;overflow:hidden;background:url('./images/mcbg.png') no-repeat;background-size:100%;}
    #musicControl a audio{width:100%;height:56px;}
    #musicControl a.stop { background-position:left bottom;}
    #musicControl a.on { background-position:0px 1px;-webkit-animation: reverseRotataZ 1.2s linear infinite;}
	</style>
	<style media="screen">
	button {
		border:1px solid #1e7db9;
		box-shadow: 0 1px 2px #8fcaee inset,0 -1px 0 #497897 inset,0 -2px 3px #8fcaee inset;
		background: -webkit-linear-gradient(top,#42a4e0,#2e88c0);
		background: -moz-linear-gradient(top,#42a4e0,#2e88c0);
		background: linear-gradient(top,#42a4e0,#2e88c0);
		width: 140px;
		line-height: 38px;
		text-align: center;
		font-weight: bold;
		color: #fff;
		text-shadow:1px 1px 1px #333;
		border-radius: 5px;
		margin:0 20px 20px 0;
		position: relative;
		overflow: hidden;
}
	.mask {
z-index: 9998;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:#000;
opacity:0.4;
filter:alpha(opacity=40);
display:none
}
.onmask {
z-index:9999;
position: fixed;
margin: 0 auto;
/*position:fixed;*/
top:30%;
left:10%;
/*width:200px;*/
height:60px;
margin:0 auto;
border-radius:5px;
border:solid 2px #666;
/*background-color:blue;*/
/*color: white;*/
color: black;
text-align: center;
display:none;
box-shadow: 0 0 10px #666;
}
	</style>
	<style type="text/css">
	/*Stylesheet*/
BODY, HTML
{
		-webkit-tap-highlight-color: rgba(0,0,0,0);
		-webkit-touch-callout: none;
		-webkit-text-size-adjust: none;
		-webkit-user-select: none;
	margin: 			0;
	padding: 			0;
	font-family: 		Arial, Verdana, sans-serif;
	font-size: 			12px;
	font-weight:		normal;
	/*color: 				#ccc;*/
	background-color:	white;
	overflow-x:hidden;
  overflow-y:hidden;
}

#sence {
	width: 100%;
	height: 100%;
	/*position: absolute;*/
	text-align:center;
	margin: 0 auto;
		display: block !important;
}
	</style>
</head>


<body>
	<div class="mask" id="mask">

	</div>
	<div class="onmask" id="safe" style="background-color:white">
		<h1>驾驶员和副驾驶都必须系好安全带，驾驶员也有提醒、督促副驾驶系安全带的义务哦！</h1>
	</div>

	<div class="onmask" id="pai" style="background-color:white">
		<!-- <div style="margin:0 auto"> -->
			<h1>前方下高架需要变道,注意要在车道变成虚线时变道哦</h1>
		<!-- </div> -->

	</div>
	<div class="onmask" id="hitTip" style="background-color:white">
		<div class="" style="float:left;width:20%">
			<img src="images/tip.png" width="50%" alt="" style="margin-left:25%;margin-top:20%"/>
		</div>
		<div class="" >

			<h2>汽车在路面上行驶追尾前车的话，一般是追尾着全责哦！</h2>
		</div>

		<center>
			<button type="button" name="button" id='know'>我知道了，重新开始</button>
		</center>
	</div>
	<div class="onmask" id="hitschool" style="background-color:white">
		<div class="" style="float:left;width:20%">
			<img src="images/tip.png" width="50%" alt="" style="margin-left:25%;margin-top:20%"/>
		</div>
		<div class="" >

			<h2>为了进一步确保校车出行安全，社会车辆不避让校车将会被依法处罚款并扣分哦！</h2>
		</div>

		<center>
			<button type="button" name="button" id='schoolknow'>我知道了，重新开始</button>
		</center>
	</div>
	<div class="onmask" id="phone" style="background-color:white">
		<div class="" style="float:left;width:20%">
			<img src="images/phone.png" width="50%" style="margin-left:25%;margin-top:20%" alt="" />
		</div>
		<div class="" >
			<h1>老板来电话了！</h1>
			<h2><a id="jie">接</a><a id="bujie" style="margin-left:100px">不接</a></h2>
			<h2><a id="text"></a></h2>
		</div>

	</div>

	<div class="onmask" id="tipline" style="background-color:white">
		<div class="" style="float:left;width:20%">
			<img src="images/tip.png" width="50%" alt="" style="margin-left:25%;margin-top:20%"/>
		</div>
		<div class="" >
			<h2>驾驶机动车不按规定超车、让行的，或者逆向行驶的，或是在规定时间内驶入公交车道的，将被处以扣分并罚款哦！</h2>
		</div>
			<center><button type="button" id="linekonw" name="button">我知道了，重新开始</button></center>
	</div>
	<div class="onmask" id="tipcline" style="background-color:white">
		<div class="" style="float:left;width:20%">
			<img src="images/tip.png" width="50%" alt="" style="margin-left:25%;margin-top:20%"/>
		</div>
		<div class="" >

			<h2>公路中划的道线有实线与虚线之分，按规定，一般在不影响其他车辆正常行驶的情况下可以在虚线变道，但实线是不能变化车道的哦！</h2>
		</div>
			<center><button type="button" id="clinekonw" name="button">我知道了，重新开始</button></center>
	</div>
	<div class="onmask" id="tipmiss" style="background-color:white">
		<div class="" style="float:left;width:20%">
			<img src="images/tip.png" width="50%" alt="" style="margin-left:25%;margin-top:20%"/>
		</div>
		<div class="" >

			<h2>你错过了正确的高架出口</h2>
		</div>
		<center><button type="button" id="misskonw" name="button">我知道了，重新开始</button></center>
	</div>
<div class="mainbox" id="main">

	<canvas id="sence" width="400" height="400"></canvas>
</div>
<span id="musicControl" style="display:none">
    <a id="mc_play" class="stop on" onclick="play_music();">
        <audio id="bgmusic" loop="loop" autoplay="autoplay">
            <source src="music/TheFatRat.mp3" type="audio/mpeg">
        </audio>
    </a>
    <a id="coin_play" style="display:none">
        <audio id="coinmusic" loop="loop">
            <source src="http://resources-user-audio.vxue360.com/778f8723e176c828c280f7c9b7eb6e00.mp3" type="audio/mpeg">
        </audio>
    </a>
</span>
<script src="lib/jquery.js"></script>
<script src="lib/util.js"></script>
<script src="lib/entities.js"></script>
<script src="user-entities.js"></script>
<script src="lib/patch-enhancement.js"></script>
<script src="lib/main_app.js"></script>

<script type="text/javascript">
var gnfx=document.documentElement.clientWidth;
var gnfy=document.documentElement.clientHeight;
var rwo=true;
var screenObjects = [];
var startTime = null;
var welcome;
var noHit=true;
var resources = [
	{'name': 'car1', src: 'images/car1.png', type: 'images'},
	{'name': 'car2', src: 'images/car2.png', type: 'images'},
	{'name': 'car3', src: 'images/car3.png', type: 'images'},
	{'name': 'car4', src: 'images/car4.png', type: 'images'},
	{'name': 'car5', src: 'images/car5.png', type: 'images'},
	{'name': 'car_p', src: 'images/car_p.png', type: 'images'},
	{'name': 'schoolBus', src: 'images/2.png', type: 'images'},
	{'name': 'roadD', src: 'images/5.png', type: 'images'},
	{'name': 'roadG1', src: 'images/9.png', type: 'images'},
	{'name': 'roadG', src: 'images/11.png', type: 'images'},
	{'name': 'pai', src: 'images/7.png', type: 'images'},
	{'name':'yes',src:'images/yes.png',type:'images'},
	{'name':'person',src:'images/person.png',type:'images'},
	{'name':'no',src:'images/no.png',type:'images'},
	{'name':'up',src:'images/up.png',type:'images'},
	{'name':'down',src:'images/down.png',type:'images'},
	{'name':'left',src:'images/left.png',type:'images'},
	{'name':'right',src:'images/right.png',type:'images'},
	{'name':'logo',src:'images/logo.jpg',type:'images'}
];
resourceLoader.onProgress = function(e){
	loadScreen.setProgress(e.loadedCount / e.totalCount);
};

resourceLoader.onComplete = function(){
	ScreenObjPool.remove(loadScreen);
	showWelcome();
	//gameJieshao();
	//lineGame();
	//avoidGame();
	//background();
	//gameSafe();
	//runWithOther();
	//startGame();
	//schoolCar();
	//biandao();
	//newEnd();
};
var loadScreen = new LoadScreen();

MainApp.init();

MainApp.startRun();

ScreenObjPool.add(loadScreen);

resourceLoader.load(resources);

document.getElementById("sence").width=gnfx;
document.getElementById("sence").height=gnfy;
function showWelcome(){
	var logo = new staticImg(resourceLoader.get('logo'), new Vector(50*gnfx/400, 100*gnfy/710), 300*gnfx/400, 400*gnfy/710);
  ScreenObjPool.add(logo);
	//var logo = new TextEntityObject('CAR RACE', new Vector(100*gnfx/400, 350*gnfy/710), {fillStyle: '#900', font: 'bold '+100*gnfx/400+'px 微软雅黑', 'textBaseline': 'top'}, 200*gnfx/400, 35*gnfy/710);

	welcome = new TextEntityObject('点击开始', new Vector(140*gnfx/400, 550*gnfy/710), {fillStyle: '#333', font: 'bold '+30*gnfx/400+'px 微软雅黑', 'textBaseline': 'top'}, 100*gnfx/400, 35*gnfy/710);
	MainApp.addEventListener(welcome, 'mouseover', function(e){
		welcome.setStyle({fillStyle: '#999'});
	});

	MainApp.addEventListener(welcome, 'mouseout', function(e){
		welcome.setStyle({fillStyle: '#333'});
	});

	MainApp.addEventListener(welcome, 'click', function(e){
		ScreenObjPool.remove(logo);
		ScreenObjPool.remove(welcome);
		gameJieshao();
	});
	//ScreenObjPool.add(logo);
	ScreenObjPool.add(welcome);

}
var SCORE = 0;
function startGame(){
	noHit=true;
    var road = new ImageEntityObject(resourceLoader.get('roadG1'), new Vector(0, -710*gnfy/710), 400*gnfx/400, 1420*gnfy/710, new Vector(0,100));
	ScreenObjPool.add(road);

	var images = [];
	images.push(resourceLoader.resources.car1);
	images.push(resourceLoader.resources.car2);
	images.push(resourceLoader.resources.car3);
	images.push(resourceLoader.resources.car4);
	images.push(resourceLoader.resources.car5);
	var img =  resourceLoader.resources.car5;
	var newCar = new Car(new Vector((0 * 74 + 55)*gnfx/400, window.util.random(-480, -80)*gnfy/710), window.util.randomColor(), img);
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car4;
	var newCar = new Car(new Vector((1 * 74 + 55)*gnfx/400, window.util.random(-480, -80)*gnfy/710), window.util.randomColor(), img);
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car3;
	var newCar = new Car(new Vector((2 * 74 + 55)*gnfx/400, window.util.random(-480, -80)*gnfy/710), window.util.randomColor(), img);
	newCar.hitable = true;
	ScreenObjPool.add(newCar);

	var scorePre = new TextEntityObject('Score: ', new Vector(50, 5), {fillStyle: '#fff', font: 'bold 32px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	ScreenObjPool.add(scorePre);
	//var score = new TextEntityObject('0', new Vector(160, 5), {fillStyle: '#fff', font: 'bold 32px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	var score = new GameScore(0, new Vector(160, 5));
	ScreenObjPool.add(score);

	var leftC = new CollisionEntityObject(new Vector(0, 0), 40*gnfx/400, 710*gnfy/710);
	var rightC = new CollisionEntityObject(new Vector(325*gnfx/400, 0), 75*gnfx/400, 710*gnfy/710);
	var topC = new CollisionEntityObject(new Vector(0, 0), 400*gnfx/400, 20*gnfy/710);
	var bottomC = new CollisionEntityObject(new Vector(0, 710*gnfy/710), 400*gnfx/400, 10);
	var cMap = new CollistionMap();
	cMap.add(leftC);
	cMap.add(rightC);
	cMap.add(topC);
	cMap.add(bottomC);

	var myCar = new Car(new Vector(200*gnfx/400, 600*gnfy/710), window.util.randomColor(), resourceLoader.resources.car_p, new Vector(0, 0));
	myCar.setCollisionMap(cMap);
	carKey(myCar);

	MainApp.addEventListener(myCar, 'hit', function(e){//弹框  不能撞击其他车辆
		clearTimeout(stoRwo);
		MainApp.stopRun();
		hitTip(function() {
			ScreenObjPool.empty();
			MainApp.emptyEventsPool();
			KEY_LOCK = {
				LEFT: false,
				RIGHT: false,
				UP: false,
				DOWN: false
			};
			MainApp.keepRun();
			startGame();
		});

		//endGame(score.score);
	});
	ScreenObjPool.add(myCar);

	if (rwo) {
		runWithOther();
	}

}
//最后一个的逻辑，小车排队不能变道
function lineGame(){
	var road = new ImageEntityObject(resourceLoader.get('roadD'), new Vector(0, -710*gnfy/710), 400*gnfx/400, 1420*gnfy/710, new Vector(0,100));
    ScreenObjPool.add(road);
	var img =  resourceLoader.resources.car5;
	var newCar = new Car(new Vector(200*gnfx/400, 0*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car1;
	var newCar = new Car(new Vector(200*gnfx/400, 100*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car2;
	var newCar = new Car(new Vector(200*gnfx/400, 200*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car3;
	var newCar = new Car(new Vector(200*gnfx/400, 300*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car2;
	var newCar = new Car(new Vector(200*gnfx/400, 620*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);

	var img =  resourceLoader.resources.car4;
	var newCar = new ConverseCar(new Vector(125*gnfx/400, 20*gnfy/710), window.util.randomColor(), img, new Vector(0, 200*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);

	var leftC = new CollisionEntityObject(new Vector(0, 0), 40*gnfx/400, 710*gnfy/710);
	var rightC = new CollisionEntityObject(new Vector(325*gnfx/400, 0), 75*gnfx/400, 710*gnfy/710);
	var topC = new CollisionEntityObject(new Vector(0, 0), 400*gnfx/400, 20*gnfy/710);
	var bottomC = new CollisionEntityObject(new Vector(0, 710*gnfy/710), 400*gnfx/400, 10);
	var cMap = new CollistionMap();
	cMap.add(leftC);
	cMap.add(rightC);
	cMap.add(topC);
	cMap.add(bottomC);

	var myCar = new Car(new Vector(200*gnfx/400, 500*gnfy/710), window.util.randomColor(), resourceLoader.resources.car_p, new Vector(0, 0));
	myCar.setCollisionMap(cMap);
	carKey(myCar);
	MainApp.addEventListener(myCar, 'hit', function(e){//弹框不能撞击其他车辆
		MainApp.stopRun();
    hitTip(function() {
      ScreenObjPool.empty();
  		MainApp.emptyEventsPool();
  		KEY_LOCK = {
  			LEFT: false,
  			RIGHT: false,
  			UP: false,
  			DOWN: false
  		};
      MainApp.keepRun();
      lineGame();
    });
		//endGame(score.score);
	});
	myCar.lineable=true;
	MainApp.addEventListener(myCar, 'line', function(e){//不能向公交车专用道或者对向车道变道
		MainApp.stopRun();
		$('.mask').fadeIn(100);
		$('#tipline').fadeIn(100);
		$('#linekonw').on('click',function() {
			$('.mask').fadeOut(100);
			$('#tipline').fadeOut(100);
			ScreenObjPool.empty();
			MainApp.emptyEventsPool();
			KEY_LOCK = {
				LEFT: false,
				RIGHT: false,
				UP: false,
				DOWN: false
			}
			MainApp.keepRun();
			lineGame();
		});

	});
	myCar.end=true;
	MainApp.addEventListener(myCar, 'end', function(e){//全屏幕，游戏结束（最后做）
		//alert("end");
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		newEnd();
	});
	myCar.addcar=true;
	MainApp.addEventListener(myCar, 'addcar', function(e){
    myCar.addcar=false;
		var img =  resourceLoader.resources.car5;
		var newCar = new Car(new Vector(200*gnfx/400, 700*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
		newCar.hitable = true;
		ScreenObjPool.add(newCar);
	});
		ScreenObjPool.add(myCar);

}
//倒数第二个逻辑，避让行人
function avoidGame(){
    var road = new ImageEntityObject(resourceLoader.get('roadG1'), new Vector(0, -710*gnfy/710), 400*gnfx/400, 1420*gnfy/710, new Vector(0,100));
	ScreenObjPool.add(road);
	var img =  resourceLoader.resources.person;
	var newCar = new Car(new Vector(320*gnfx/400, 240*gnfy/710), window.util.randomColor(), img, new Vector(-10,100));
	newCar.hitable = true;
	newCar.avoid=true;
	ScreenObjPool.add(newCar);

	var img =  resourceLoader.resources.car5;
	var newCar = new Car(new Vector(271*gnfx/400, 0*gnfy/710), window.util.randomColor(), img, new Vector(0, 20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car1;
	var newCar = new Car(new Vector(129*gnfx/400, 100*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car2;
	var newCar = new Car(new Vector(129*gnfx/400, 300*gnfy/710), window.util.randomColor(), img, new Vector(0, 20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car3;
	var newCar = new Car(new Vector(57*gnfx/400, 400*gnfy/710), window.util.randomColor(), img, new Vector(0, -20*gnfy/710));
	newCar.hitable = true;
	ScreenObjPool.add(newCar);

	var leftC = new CollisionEntityObject(new Vector(0, 0), 40*gnfx/400, 710*gnfy/710);
	var rightC = new CollisionEntityObject(new Vector(325*gnfx/400, 0), 75*gnfx/400, 710*gnfy/710);
	var topC = new CollisionEntityObject(new Vector(0, 0), 400*gnfx/400, 20*gnfy/710);
	var bottomC = new CollisionEntityObject(new Vector(0, 710*gnfy/710), 400*gnfx/400, 10);
	var cMap = new CollistionMap();
	cMap.add(leftC);
	cMap.add(rightC);
	cMap.add(topC);
	cMap.add(bottomC);

	var myCar = new Car(new Vector(271*gnfx/400, 500*gnfy/710), window.util.randomColor(), resourceLoader.resources.car_p, new Vector(0, 0));
	myCar.setCollisionMap(cMap);
	carKey(myCar);


	MainApp.addEventListener(myCar, 'hit', function(e){//弹框，不能撞击行人
		MainApp.stopRun();
    hitTip(function() {
      ScreenObjPool.empty();
  		MainApp.emptyEventsPool();
  		KEY_LOCK = {
  			LEFT: false,
  			RIGHT: false,
  			UP: false,
  			DOWN: false
  		};
      MainApp.keepRun();
      avoidGame();
    });

		//endGame(score.score);
	});
	MainApp.addEventListener(myCar, 'avoid', function(e){//全屏幕，成功避让行人，下一关
		// alert("avoid");
		ScreenObjPool.empty();
		MainApp.emptyEventsPool();
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		next = new TextEntityObject('成功避让行人，下一关:', new Vector(80*gnfx/400, 200*gnfy/710), {fillStyle: '#900', font: 'bold '+40*gnfx/400+'px 微软雅黑', 'textBaseline': 'top'}, 200*gnfx/400, 35*gnfy/710);
    next1 = new TextEntityObject('请不要占用公交车专用道和对向车道', new Vector(40*gnfx/400, 350*gnfy/710), {fillStyle: '#900', font: 'bold '+40*gnfx/400+'px 微软雅黑', 'textBaseline': 'top'}, 300*gnfx/400, 35*gnfy/710);
		ScreenObjPool.add(next);
		ScreenObjPool.add(next1);
		setTimeout(function(){
			ScreenObjPool.empty();
			lineGame();
		},2000);

		//endGame(score.score);
	});
		ScreenObjPool.add(myCar);



}
//在高架上时的背景车道，只是要变道逻辑时
function background(){
	var road = new ImageEntityObject(resourceLoader.get('roadG'), new Vector(0, -2840*gnfy/710), 400*gnfx/400, 3550*gnfy/710, new Vector(0,100));
	road.miss=true;
	road.change=true;
	road.cline=true;
	ScreenObjPool.add(road);
	var images = [];
	images.push(resourceLoader.resources.car1);
	images.push(resourceLoader.resources.car2);
	images.push(resourceLoader.resources.car3);
	images.push(resourceLoader.resources.car4);
	images.push(resourceLoader.resources.car5);
	var img =  resourceLoader.resources.car1;
	var newCar = new Car(new Vector((0 * 74 + 55)*gnfx/400, window.util.random(-480, -80)*gnfy/710), window.util.randomColor(), img);
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car2;
	var newCar = new Car(new Vector((1 * 74 + 55)*gnfx/400, window.util.random(-480, -80)*gnfy/710), window.util.randomColor(), img);
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var img =  resourceLoader.resources.car3;
	var newCar = new Car(new Vector((2 * 74 + 55)*gnfx/400, window.util.random(-480, -80)*gnfy/710), window.util.randomColor(), img);
	newCar.hitable = true;
	ScreenObjPool.add(newCar);
	var scorePre = new TextEntityObject('Score: ', new Vector(50, 5), {fillStyle: '#fff', font: 'bold 32px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	ScreenObjPool.add(scorePre);
	//var score = new TextEntityObject('0', new Vector(160, 5), {fillStyle: '#fff', font: 'bold 32px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	var score = new GameScore(0, new Vector(160, 5));
	ScreenObjPool.add(score);

	var leftC = new CollisionEntityObject(new Vector(0, 0), 40*gnfx/400, 710*gnfy/710);
	var rightC = new CollisionEntityObject(new Vector(325*gnfx/400, 0), 75*gnfx/400, 710*gnfy/710);
	var topC = new CollisionEntityObject(new Vector(0, 0), 400*gnfx/400, 20*gnfy/710);
	var bottomC = new CollisionEntityObject(new Vector(0, 710*gnfy/710), 400*gnfx/400, 10);
	var cMap = new CollistionMap();
	cMap.add(leftC);
	cMap.add(rightC);
	cMap.add(topC);
	cMap.add(bottomC);

	var myCar = new Car(new Vector(200*gnfx/400, 600*gnfy/710), window.util.randomColor(), resourceLoader.resources.car_p, new Vector(0, 0));
	myCar.setCollisionMap(cMap);
	carKey(myCar);
	MainApp.addEventListener(myCar, 'hit', function(e){
		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		}
		MainApp.stopRun();
		hitTip(function() {
			MainApp.keepRun();
			background();
		});
	});
	MainApp.addEventListener(myCar, 'cline', function(e){//弹框实现不能变道

		MainApp.stopRun();
		$('.mask').fadeIn(100);
		$('#tipcline').fadeIn(100);
		$('#clinekonw').on('click',function() {
			$('.mask').fadeOut(100);
			$('#tipcline').fadeOut(100);
			ScreenObjPool.empty();
			MainApp.emptyEventsPool();
			KEY_LOCK = {
				LEFT: false,
				RIGHT: false,
				UP: false,
				DOWN: false
			}
			MainApp.keepRun();
			background();
		});
	});
	MainApp.addEventListener(myCar, 'miss', function(e){//弹框，错过了下高架
		MainApp.stopRun();
		$('.mask').fadeIn(100);
		$('#tipmiss').fadeIn(100);
		$('#misskonw').on('click',function() {
			$('.mask').fadeOut(100);
			$('#tipmiss').fadeOut(100);
			ScreenObjPool.empty();
			MainApp.emptyEventsPool();
			KEY_LOCK = {
				LEFT: false,
				RIGHT: false,
				UP: false,
				DOWN: false
			}
			MainApp.keepRun();
			background();
		});
	});
	MainApp.addEventListener(myCar, 'change', function(e){//全屏幕，正确下高架，经行下一关

		ScreenObjPool.empty();
		MainApp.emptyEventsPool();

		KEY_LOCK = {
			LEFT: false,
			RIGHT: false,
			UP: false,
			DOWN: false
		};
		next = new TextEntityObject('正确下高架，下一关:', new Vector(60*gnfx/400, 200*gnfy/710), {fillStyle: '#900', font: 'bold '+40*gnfx/400+'px 微软雅黑', 'textBaseline': 'top'}, 200*gnfx/400, 35*gnfy/710);
		next1 = new TextEntityObject('请减速避让道路上的校车', new Vector(40*gnfx/400, 350*gnfy/710), {fillStyle: '#900', font: 'bold '+40*gnfx/400+'px 微软雅黑', 'textBaseline': 'top'}, 300*gnfx/400, 35*gnfy/710);
		ScreenObjPool.add(next);
		ScreenObjPool.add(next1);
		setTimeout(function(){
			ScreenObjPool.empty();
			MainApp.emptyEventsPool();
			schoolCar();
		},2000);
	});
	ScreenObjPool.add(myCar);

}

function stop_coin_music(){
	$('#coin_play audio').get(0).pause();
}

function play_coin_music(){
	$('#coin_play audio').get(0).load();
	$('#coin_play audio').get(0).play();
	var t=setTimeout("stop_coin_music()",5000);
}

function stopGame() {
	//var stop=new ;
	MainApp.stopRun();
}
function endGame(score){

	var end = new TextEntityObject('GAME OVER', new Vector(120, 150), {fillStyle: '#900', font: 'bold 64px 微软雅黑', 'textBaseline': 'top'}, 100, 35);

	ScreenObjPool.add(end);

	var score = new TextEntityObject('Score: ' + ~~score, new Vector(240,240), {fillStyle: '#000', font: 'bold 32px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	ScreenObjPool.add(score);

	var restart = new TextEntityObject('重新开始', new Vector(267, 310), {fillStyle: '#333', font: 'bold 24px 微软雅黑', 'textBaseline': 'top'}, 100, 35);
	MainApp.addEventListener(restart, 'mouseover', function(e){
		restart.setStyle({fillStyle: '#999'});
	});


	MainApp.addEventListener(restart, 'mouseout', function(e){
		restart.setStyle({fillStyle: '#333'});
	});

	ScreenObjPool.add(restart);

	MainApp.addEventListener(restart, 'click', function(e){
		ScreenObjPool.remove(end);
		ScreenObjPool.remove(restart);

		startGame();
	});

}


var KEY_LOCK = {
	LEFT: false,
	RIGHT: false,
	UP: false,
	DOWN: false
}

</script>
<script type="text/javascript">
function play_music(){
    if ($('#mc_play').hasClass('on')){
        $('#mc_play audio').get(0).pause();
        $('#mc_play').attr('class','stop');
    }else{
        $('#mc_play audio').get(0).play();
        $('#mc_play').attr('class','on');
    }
    event.stopPropagation(); //阻止冒泡
}
function just_play(id){
    $('#mc_play audio').get(0).play();
    $('#mc_play').attr('class','on');
    event.stopPropagation(); //阻止冒泡
}
    function is_weixn(){
        return false;
        var ua = navigator.userAgent.toLowerCase();
        if(ua.match(/MicroMessenger/i)=="micromessenger") {
            return true;
        } else {
            return false;
        }
    }
    window.onload=function(){
        if (!is_weixn()){
            just_play();
        }
    }
</script>
<script src="gameCtrl.js"></script>
<script src="webview.js" charset="utf-8"></script>

</body>
</html>
